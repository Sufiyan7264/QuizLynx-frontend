<div class="batch-detail-container !pt-24">
  <p-toast></p-toast>
  
  <!-- Header Section -->
  <div class="detail-header">
    <div class="header-content">
      <button class="back-btn" (click)="goBack()">
        <i class="pi pi-arrow-left"></i>
        <span>Back to Batches</span>
      </button>
      <h1 class="page-title">{{ batch?.batchName || 'Batch Details' }}</h1>
      <p class="page-subtitle">{{ batch?.description || 'View students and quizzes in this batch' }}</p>
      @if (batch) {
        <div class="batch-info-header">
          <div class="info-badge">
            <i class="pi pi-users"></i>
            <span>{{ batch.studentCount || students.length }} Students</span>
          </div>
          <div class="info-badge">
            <i class="pi pi-book"></i>
            <span>{{ batch.quizCount || quizzes.length }} Quizzes</span>
          </div>
          @if (batch.batchCode) {
            <div class="info-badge">
              <i class="pi pi-key"></i>
              <span>Code: {{ batch.batchCode }}</span>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Tabs Section -->
  <div class="tabs-section">
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'students'"
      (click)="setActiveTab('students')"
    >
      <i class="pi pi-users"></i>
      <span>Students ({{ students.length }})</span>
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'quizzes'"
      (click)="setActiveTab('quizzes')"
    >
      <i class="pi pi-book"></i>
      <span>Quizzes ({{ quizzes.length }})</span>
    </button>
  </div>

  <!-- Students Tab -->
  @if (activeTab === 'students') {
    <div class="tab-content">
      <!-- Search Section -->
      @if (students.length > 0) {
        <div class="search-section">
          <div class="search-group">
            <label for="studentSearch" class="search-label">
              <i class="pi pi-search"></i>
              Search Students
            </label>
            <input
              id="studentSearch"
              type="text"
              pInputText
              [(ngModel)]="studentSearchTerm"
              (ngModelChange)="onStudentSearchChange()"
              placeholder="Search by name, username, or email..."
              class="search-input"
            />
          </div>
          @if (studentSearchTerm) {
            <button class="clear-search-btn" (click)="clearStudentSearch()">
              <i class="pi pi-times"></i>
              <span>Clear</span>
            </button>
          }
        </div>
      }

      <!-- Students List -->
      <div class="students-list">
        @if (students.length === 0) {
          <div class="empty-state">
            <i class="pi pi-users empty-icon"></i>
            <h3>No students yet</h3>
            <p>Students will appear here once they join this batch</p>
          </div>
        } @else {
          @if (filteredStudents.length === 0 && studentSearchTerm) {
            <div class="empty-state">
              <i class="pi pi-search empty-icon"></i>
              <h3>No students found</h3>
              <p>Try adjusting your search criteria</p>
              <button class="clear-search-btn" (click)="clearStudentSearch()">
                <i class="pi pi-times"></i>
                <span>Clear Search</span>
              </button>
            </div>
          } @else {
            <div class="students-grid">
              @for (student of filteredStudents; track student.id) {
                <div class="student-card">
                  <div class="student-header">
                    <div class="student-avatar">
                      @if (student.avatarUrl) {
                        <img [src]="student.avatarUrl" [alt]="getStudentDisplayName(student)" />
                      } @else {
                        <span class="avatar-initials">{{ getStudentInitials(student) }}</span>
                      }
                    </div>
                    <div class="student-info">
                      <h3 class="student-name">{{ getStudentDisplayName(student) }}</h3>
                      <p class="student-username">@{{ student.username || 'N/A' }}</p>
                    </div>
                  </div>
                  
                  <div class="student-content">
                    <div class="info-row">
                      <div class="info-item">
                        <i class="pi pi-envelope"></i>
                        <span>{{ student.email || 'No email' }}</span>
                      </div>
                    </div>
                    @if (student.averageScore !== undefined) {
                      <div class="info-row">
                        <div class="info-item">
                          <i class="pi pi-chart-line"></i>
                          <span>Avg Score: {{ student.averageScore.toFixed(1) }}%</span>
                        </div>
                      </div>
                    }
                    @if (student.quizzesCompleted !== undefined) {
                      <div class="info-row">
                        <div class="info-item">
                          <i class="pi pi-check-circle"></i>
                          <span>{{ student.quizzesCompleted }} Quizzes Completed</span>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        }
      </div>
    </div>
  }

  <!-- Quizzes Tab -->
  @if (activeTab === 'quizzes') {
    <div class="tab-content">
      <!-- Search Section -->
      @if (quizzes.length > 0) {
        <div class="search-section">
          <div class="search-group">
            <label for="quizSearch" class="search-label">
              <i class="pi pi-search"></i>
              Search Quizzes
            </label>
            <input
              id="quizSearch"
              type="text"
              pInputText
              [(ngModel)]="quizSearchTerm"
              (ngModelChange)="onQuizSearchChange()"
              placeholder="Search by title, description, or subject..."
              class="search-input"
            />
          </div>
          @if (quizSearchTerm) {
            <button class="clear-search-btn" (click)="clearQuizSearch()">
              <i class="pi pi-times"></i>
              <span>Clear</span>
            </button>
          }
        </div>
      }

      <!-- Quizzes List -->
      <div class="quizzes-list">
        @if (quizzes.length === 0) {
          <div class="empty-state">
            <i class="pi pi-file-edit empty-icon"></i>
            <h3>No quizzes yet</h3>
            <p>Quizzes will appear here once they are added to this batch</p>
          </div>
        } @else {
          @if (filteredQuizzes.length === 0 && quizSearchTerm) {
            <div class="empty-state">
              <i class="pi pi-search empty-icon"></i>
              <h3>No quizzes found</h3>
              <p>Try adjusting your search criteria</p>
              <button class="clear-search-btn" (click)="clearQuizSearch()">
                <i class="pi pi-times"></i>
                <span>Clear Search</span>
              </button>
            </div>
          } @else {
            <div class="quizzes-grid">
              @for (quiz of filteredQuizzes; track quiz.id) {
                <div class="quiz-card">
                  <div class="quiz-header">
                    <div class="quiz-icon">
                      <i class="pi pi-file-edit"></i>
                    </div>
                    <span class="status-badge" [class]="getStatusClass(quiz.status)">
                      {{ quiz.status || 'DRAFT' }}
                    </span>
                  </div>
                  
                  <div class="quiz-content">
                    <h3 class="quiz-title">{{ quiz.title }}</h3>
                    @if (quiz.description) {
                      <p class="quiz-description">{{ quiz.description }}</p>
                    }
                    
                    <div class="quiz-info">
                      <div class="info-row">
                        <div class="info-item">
                          <i class="pi pi-book"></i>
                          <span>{{ quiz.subject || 'No subject' }}</span>
                        </div>
                        <div class="info-item">
                          <i class="pi pi-clock"></i>
                          <span>{{ quiz.duration || 0 }} min</span>
                        </div>
                      </div>
                      <div class="info-row">
                        <div class="info-item">
                          <i class="pi pi-star"></i>
                          <span>{{ quiz.totalMarks || 0 }} marks</span>
                        </div>
                        <div class="info-item">
                          <i class="pi pi-check-circle"></i>
                          <span>Pass: {{ quiz.passingMarks || 0 }}</span>
                        </div>
                      </div>
                      @if (quiz.questionCount !== undefined) {
                        <div class="info-item">
                          <i class="pi pi-question-circle"></i>
                          <span>{{ quiz.questionCount }} questions</span>
                        </div>
                      }
                      @if (quiz.dueDate) {
                        <div class="info-item">
                          <i class="pi pi-calendar"></i>
                          <span>Due: {{ formatDisplayDate(quiz.dueDate) }}</span>
                        </div>
                      }
                    </div>

                    <div class="quiz-footer">
                      <button class="view-results-btn" (click)="viewQuizResults(quiz)">
                        <i class="pi pi-chart-bar"></i>
                        <span>View Results</span>
                      </button>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        }
      </div>
    </div>
  }
</div>

