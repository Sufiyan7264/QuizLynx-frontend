<p-dialog 
  [(visible)]="visible" 
  (onHide)="closeDialog()" 
  [modal]="true" 
  [draggable]="false"
  [resizable]="false"
  styleClass="minimal-ai-dialog"
  [style]="{width: '90vw', maxWidth: step === 'preview' ? '800px' : '550px'}" 
  >
    <ng-template #header>
  <div class="dialog-header w-full">
    <div class="header-content">
      <div class="icon-wrapper">
        <i class="pi" [class]="step === 'input' ? 'pi-sparkles' : 'pi-list'"></i>
      </div>
      <div class="title-wrapper">
        <h3>{{ step === 'input' ? 'AI Generator' : 'Review Questions' }}</h3>
        <p>{{ step === 'input' ? 'Generate from text' : 'Review and select destination' }}</p>
      </div>
    </div>
    <!-- <button class="close-btn" (click)="closeDialog()"><i class="pi pi-times"></i></button> -->
  </div>
  </ng-template>

  <div class="dialog-content">
    
    @if (step === 'input') {
      <div class="input-section">
        <label class="block mb-2 font-semibold text-gray-700">Source Content</label>
        <textarea 
          pInputTextarea 
          [(ngModel)]="promptText" 
          rows="6" 
          class="minimal-textarea"
          placeholder="Paste topic content here...">
        </textarea>
        
        <div class="flex gap-2 mt-3">
          @for (preset of presets; track $index) {
            <button class="preset-chip" (click)="usePreset(preset)">{{preset}}</button>
          }
        </div>

        <div class="mt-6">
          <div class="flex justify-between mb-2">
            <label class="font-semibold text-gray-700">Question Count</label>
            <span class="bg-blue-50 dark:bg-blue-500 dark:text-white text-blue-600 px-2 py-1 rounded text-xs font-bold ">{{questionCount}}</span>
          </div>
          <p-slider [(ngModel)]="questionCount" [min]="1" [max]="20" styleClass="minimal-slider"></p-slider>
        </div>
        <div class="mt-4 flex gap-1 items-center">
          <i class="pi pi-exclamation-triangle text-danger"></i>
          <span class="text-xs text-muted-text">please check that you have created at least one quiz to add this AI generated questions</span>
        </div>
        <div class="flex mt-4 gap-1 items-center">
          <i class="pi pi-info-circle text-text"></i>
          <span class="text-xs text-muted-text">You have {{ aiUsage }} of 5 AI questions generation remaining today. <a href="/pricing" class="text-blue-600 cursor-pointer hover:underline">Click here to upgrade.</a>
          </span>
        </div>
      </div>
    }

    @if (step === 'preview') {
      <div class="preview-section h-[400px] overflow-y-auto pr-2 custom-scrollbar">
        @for (q of generatedQuestions; track $index) {
          <div class="question-card mb-3 p-4 border border-border rounded-lg bg-primary-foreground hover:shadow-sm transition-shadow">
            <div class="flex justify-between items-start mb-2">
              <span class="font-bold text-text">Q{{$index + 1}}. {{q.questionTitle}}</span>
              <span class="text-xs bg-bg px-2 py-1 text-muted-text rounded">{{q.difficultyLevel}}</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm text-muted-text ml-2">
              <div [class.text-green-600]="q.rightAnswer === q.option1" [class.font-bold]="q.rightAnswer === q.option1">A) {{q.option1}}</div>
              <div [class.text-green-600]="q.rightAnswer === q.option2" [class.font-bold]="q.rightAnswer === q.option2">B) {{q.option2}}</div>
              <div [class.text-green-600]="q.rightAnswer === q.option3" [class.font-bold]="q.rightAnswer === q.option3">C) {{q.option3}}</div>
              <div [class.text-green-600]="q.rightAnswer === q.option4" [class.font-bold]="q.rightAnswer === q.option4">D) {{q.option4}}</div>
            </div>
          </div>
        }
      </div>

      <div class="mt-4 p-4 bg-primary-foreground rounded-lg border border-border">
        <label class="block mb-2 text-sm font-semibold text-text">Add to Quiz</label>
        <p-select 
          [options]="quizzes" 
          [(ngModel)]="selectedQuiz" 
          optionLabel="title" 
          placeholder="Select a Quiz" 
          styleClass="w-full"
          [appendTo]="'body'">
        </p-select>
      </div>
    }
  </div>
<ng-template #footer>
  <div class="dialog-footer w-full">
    @if (step === 'input') {
      <button pButton label="Cancel" class="p-button-text px-2 text-gray-500" (click)="closeDialog()"></button>
      <button 
        pButton 
        label="Generate Preview" 
        icon="pi pi-bolt" 
        (click)="generatePreview()" 
        [loading]="isProcessing"
        [disabled]="!promptText || aiUsage === 0">
      </button>
    } @else {
      <button pButton label="Back" icon="pi pi-arrow-left" class="p-button-text" (click)="step = 'input'"></button>
      <button 
        pButton 
        label="Confirm & Save" 
        icon="pi pi-check" 
        class="p-button-success" 
        styleClass="border-0"
        (click)="saveQuestions()" 
        [loading]="isProcessing"
        [disabled]="!selectedQuiz">
      </button>
    }
  </div>
  </ng-template>
</p-dialog>